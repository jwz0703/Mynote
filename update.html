<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 倉庫檔案管理器</title>
    <style>
        :root {
            --primary-bg: #f6f8fa;
            --secondary-bg: #ffffff;
            --border-color: #d0d7de;
            --text-color: #24292f;
            --link-color: #0969da;
            --button-bg: #2c974b;
            --button-hover-bg: #298e46;
            --button-text: #ffffff;
            --danger-bg: #d73a49;
            --danger-hover-bg: #cb2431;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        }
        body {
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
        }
        h1, h2 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: var(--font-family);
            font-size: 14px;
        }
        textarea {
            min-height: 200px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            color: var(--button-text);
            background-color: var(--button-bg);
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: var(--button-hover-bg);
        }
        button.danger {
            background-color: var(--danger-bg);
        }
        button.danger:hover {
            background-color: var(--danger-hover-bg);
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        #file-browser {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            min-height: 100px;
            background-color: var(--primary-bg);
        }
        #file-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #file-list li {
            padding: 5px;
            display: flex;
            align-items: center;
        }
        #file-list li:hover {
            background-color: #eaeef2;
            border-radius: 4px;
        }
        #file-list a {
            color: var(--link-color);
            text-decoration: none;
            cursor: pointer;
        }
        #file-list a:hover {
            text-decoration: underline;
        }
        .file-icon {
            margin-right: 8px;
        }
        #log-output {
            margin-top: 20px;
            background-color: #24292f;
            color: #c9d1d9;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .flex-container {
            display: flex;
            gap: 20px;
        }
        .flex-item {
            flex: 1;
        }
        @media (max-width: 768px) {
            .flex-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>GitHub 倉庫檔案管理器</h1>
        
        <section>
            <h2>1. 認證與倉庫設定</h2>
            <div class="form-group">
                <label for="github-token">GitHub Personal Access Token (需 repo 權限)</label>
                <input type="password" id="github-token" placeholder="貼上您的 Token">
            </div>
            <div class="flex-container">
                <div class="form-group flex-item">
                    <label for="owner">倉庫擁有者 (Owner)</label>
                    <input type="text" id="owner" placeholder="例如: octocat">
                </div>
                <div class="form-group flex-item">
                    <label for="repo">倉庫名稱 (Repo)</label>
                    <input type="text" id="repo" placeholder="例如: Hello-World">
                </div>
                <div class="form-group flex-item">
                    <label for="branch">分支 (Branch)</label>
                    <input type="text" id="branch" value="main">
                </div>
            </div>
        </section>

        <section>
            <h2>2. 檔案瀏覽器</h2>
            <div class="form-group">
                <label for="current-path">目前路徑</label>
                <input type="text" id="current-path" value="">
            </div>
            <div class="button-group">
                <button onclick="listContents()">瀏覽/刷新目前路徑</button>
            </div>
            <div id="file-browser" style="margin-top: 15px;">
                <ul id="file-list"></ul>
            </div>
        </section>

        <section>
            <h2>3. 檔案/資料夾操作</h2>
            <div class="form-group">
                <label for="file-path">檔案路徑 (包含檔名)</label>
                <input type="text" id="file-path" placeholder="例如: src/data/my-file.txt">
            </div>
            <div class="form-group">
                <label for="file-content">檔案內容 (建立或更新時需要)</label>
                <textarea id="file-content"></textarea>
            </div>
            <div class="form-group">
                <label for="commit-message">提交訊息 (Commit Message)</label>
                <input type="text" id="commit-message" value="Operate file via web manager">
            </div>
            <div class="button-group">
                <button onclick="createOrUpdateFile()">建立 / 更新檔案</button>
                <button class="danger" onclick="deleteFile()">刪除檔案</button>
                <button onclick="createFolder()">建立資料夾 (在此路徑下)</button>
            </div>
            <p style="font-size: 12px; color: #57606a;">提示：建立資料夾會在其路徑下創建一個名為 <code>.gitkeep</code> 的空檔案。</p>
        </section>

        <section>
            <h2>日誌輸出</h2>
            <div id="log-output">日誌訊息將會顯示在這裡...</div>
        </section>
    </div>

    <script>
        // 用於儲存目前正在編輯檔案的 SHA 值
        let currentFileSha = null;

        const GITHUB_API_BASE = "https://api.github.com";

        // --- Helper Functions ---

        function getAuthHeaders() {
            const token = document.getElementById('github-token').value;
            if (!token) {
                logMessage("錯誤: 請先輸入 GitHub Token。", "error");
                throw new Error("Token is missing");
            }
            return {
                'Accept': 'application/vnd.github+json',
                'Authorization': `Bearer ${token}`,
                'X-GitHub-Api-Version': '2022-11-28'
            };
        }

        function getRepoInfo() {
            const owner = document.getElementById('owner').value;
            const repo = document.getElementById('repo').value;
            if (!owner || !repo) {
                logMessage("錯誤: 請輸入倉庫擁有者和倉庫名稱。", "error");
                throw new Error("Owner or repo is missing");
            }
            return { owner, repo };
        }
        
        function getBranch() {
            return document.getElementById('branch').value || 'main';
        }

        function logMessage(message, type = "info") {
            const logOutput = document.getElementById('log-output');
            const now = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff7b72' : (type === 'success' ? '#7ee787' : '#c9d1d9');
            logOutput.innerHTML = `<span style="color:${color};">[${now}] ${message}</span>\n` + logOutput.innerHTML;
        }

        // --- Core API Functions ---

        async function listContents(path = null) {
            const currentPathInput = document.getElementById('current-path');
            if (path === null) {
                path = currentPathInput.value;
            } else {
                currentPathInput.value = path;
            }
            
            logMessage(`正在讀取路徑: '${path || "根目錄"}'...`);

            try {
                const { owner, repo } = getRepoInfo();
                const headers = getAuthHeaders();
                const branch = getBranch();
                
                const url = `${GITHUB_API_BASE}/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
                const response = await fetch(url, { headers });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP ${response.status}: ${errorData.message}`);
                }

                const data = await response.json();
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = ''; // 清空列表

                // 處理 "回到上一層"
                if (path) {
                    const parentPath = path.substring(0, path.lastIndexOf('/'));
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="file-icon">↩️</span> <a onclick="listContents('${parentPath}')">.. (回到上一層)</a>`;
                    fileList.appendChild(li);
                }

                // 排序，資料夾在前，檔案在後
                data.sort((a, b) => {
                    if (a.type === b.type) return a.name.localeCompare(b.name);
                    return a.type === 'dir' ? -1 : 1;
                });

                data.forEach(item => {
                    const li = document.createElement('li');
                    const icon = item.type === 'dir' ? '📁' : '📄';
                    let action;
                    if (item.type === 'dir') {
                        action = `listContents('${item.path}')`;
                    } else {
                        action = `getFileContent('${item.path}')`;
                    }
                    li.innerHTML = `<span class="file-icon">${icon}</span> <a onclick="${action}">${item.name}</a>`;
                    fileList.appendChild(li);
                });
                logMessage(`成功讀取路徑 '${path || "根目錄"}' 的內容。`, "success");

            } catch (error) {
                logMessage(`讀取內容失敗: ${error.message}`, "error");
            }
        }

        async function getFileContent(path) {
            logMessage(`正在讀取檔案 '${path}'...`);
            try {
                const { owner, repo } = getRepoInfo();
                const headers = getAuthHeaders();
                const branch = getBranch();
                
                const url = `${GITHUB_API_BASE}/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
                const response = await fetch(url, { headers });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP ${response.status}: ${errorData.message}`);
                }

                const data = await response.json();
                
                if (data.encoding !== 'base64') {
                    throw new Error(`不支援的檔案編碼: ${data.encoding} (檔案可能過大)`);
                }

                document.getElementById('file-path').value = data.path;
                document.getElementById('file-content').value = atob(data.content); // Base64 解碼
                currentFileSha = data.sha; // 儲存 SHA 以供更新/刪除使用

                logMessage(`成功載入檔案 '${path}'。現在您可以編輯並更新它。`, "success");
            } catch (error) {
                logMessage(`讀取檔案失敗: ${error.message}`, "error");
            }
        }

        async function createOrUpdateFile() {
            const path = document.getElementById('file-path').value;
            const content = document.getElementById('file-content').value;
            const message = document.getElementById('commit-message').value;

            if (!path || !message) {
                logMessage("錯誤: 檔案路徑和提交訊息為必填項。", "error");
                return;
            }
            
            const action = currentFileSha && document.getElementById('file-path').value === path ? '更新' : '建立';
            logMessage(`正在${action}檔案 '${path}'...`);

            try {
                const { owner, repo } = getRepoInfo();
                const headers = getAuthHeaders();
                const branch = getBranch();

                const url = `${GITHUB_API_BASE}/repos/${owner}/${repo}/contents/${path}`;
                
                const body = {
                    message,
                    content: btoa(content), // Base64 編碼
                    branch
                };

                // 如果是更新，必須提供 SHA
                if (action === '更新') {
                    body.sha = currentFileSha;
                }

                const response = await fetch(url, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(body)
                });

                const responseData = await response.json();
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseData.message}`);
                }

                logMessage(`成功${action}檔案 '${path}'！`, "success");
                currentFileSha = responseData.content.sha; // 更新 SHA
                
                // 刷新父目錄
                const parentPath = path.includes('/') ? path.substring(0, path.lastIndexOf('/')) : '';
                listContents(parentPath);

            } catch (error) {
                logMessage(`${action}檔案失敗: ${error.message}`, "error");
            }
        }

        async function deleteFile() {
            const path = document.getElementById('file-path').value;
            const message = document.getElementById('commit-message').value;

            if (!path) {
                logMessage("錯誤: 請先載入或指定要刪除的檔案路徑。", "error");
                return;
            }
            if (!currentFileSha) {
                logMessage("錯誤: 缺少檔案的 SHA 值。請先點擊瀏覽器中的檔案以載入其資訊。", "error");
                return;
            }
            if (!confirm(`您確定要永久刪除檔案 '${path}' 嗎？此操作無法復原！`)) {
                logMessage("刪除操作已取消。");
                return;
            }

            logMessage(`正在刪除檔案 '${path}'...`);

            try {
                const { owner, repo } = getRepoInfo();
                const headers = getAuthHeaders();
                const branch = getBranch();

                const url = `${GITHUB_API_BASE}/repos/${owner}/${repo}/contents/${path}`;
                
                const body = {
                    message,
                    sha: currentFileSha,
                    branch
                };

                const response = await fetch(url, {
                    method: 'DELETE',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const responseData = await response.json();
                    throw new Error(`HTTP ${response.status}: ${responseData.message}`);
                }

                logMessage(`成功刪除檔案 '${path}'！`, "success");
                
                // 清空表單
                document.getElementById('file-path').value = '';
                document.getElementById('file-content').value = '';
                currentFileSha = null;

                // 刷新父目錄
                const parentPath = path.includes('/') ? path.substring(0, path.lastIndexOf('/')) : '';
                listContents(parentPath);

            } catch (error) {
                logMessage(`刪除檔案失敗: ${error.message}`, "error");
            }
        }
        
        async function createFolder() {
            const path = document.getElementById('file-path').value;
            if (!path) {
                logMessage("錯誤: 請在 '檔案路徑' 欄位中輸入您想建立的資料夾路徑。", "error");
                return;
            }

            // GitHub API 不能直接建立空資料夾，標準做法是建立一個 .gitkeep 檔案
            const filePathWithGitkeep = path.endsWith('/') ? `${path}.gitkeep` : `${path}/.gitkeep`;
            const commitMessage = `Create folder ${path}`;
            
            logMessage(`正在透過建立 '${filePathWithGitkeep}' 來建立資料夾...`);

            try {
                const { owner, repo } = getRepoInfo();
                const headers = getAuthHeaders();
                const branch = getBranch();

                const url = `${GITHUB_API_BASE}/repos/${owner}/${repo}/contents/${filePathWithGitkeep}`;
                
                const body = {
                    message: commitMessage,
                    content: btoa(''), // 空內容
                    branch
                };

                const response = await fetch(url, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(body)
                });

                const responseData = await response.json();
                if (!response.ok) {
                    // 如果檔案已存在，也視為一種成功
                    if (response.status === 422 && responseData.message.includes("sha")) {
                         logMessage(`資料夾 '${path}' 或其 .gitkeep 檔案已存在。`, "info");
                         return;
                    }
                    throw new Error(`HTTP ${response.status}: ${responseData.message}`);
                }

                logMessage(`成功建立資料夾 '${path}'！`, "success");
                
                // 刷新父目錄
                const parentPath = path.includes('/') ? path.substring(0, path.lastIndexOf('/')) : '';
                listContents(parentPath);

            } catch (error) {
                logMessage(`建立資料夾失敗: ${error.message}`, "error");
            }
        }

    </script>

</body>
</html>