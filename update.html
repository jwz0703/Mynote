<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub å€‰åº«æª”æ¡ˆç®¡ç†å™¨</title>
    <style>
        :root {
            --primary-bg: #f6f8fa;
            --secondary-bg: #ffffff;
            --border-color: #d0d7de;
            --text-color: #24292f;
            --link-color: #0969da;
            --button-bg: #2c974b;
            --button-hover-bg: #298e46;
            --button-text: #ffffff;
            --danger-bg: #d73a49;
            --danger-hover-bg: #cb2431;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        }
        body {
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            font-size: 14px;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
        }
        h1, h2 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: var(--font-family);
            font-size: 14px;
        }
        textarea {
            min-height: 200px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            color: var(--button-text);
            background-color: var(--button-bg);
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: var(--button-hover-bg);
        }
        button.danger {
            background-color: var(--danger-bg);
        }
        button.danger:hover {
            background-color: var(--danger-hover-bg);
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        #file-browser {
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px;
            min-height: 100px;
            background-color: var(--primary-bg);
        }
        #file-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #file-list li {
            padding: 5px;
            display: flex;
            align-items: center;
        }
        #file-list li:hover {
            background-color: #eaeef2;
            border-radius: 4px;
        }
        #file-list a {
            color: var(--link-color);
            text-decoration: none;
            cursor: pointer;
        }
        #file-list a:hover {
            text-decoration: underline;
        }
        .file-icon {
            margin-right: 8px;
        }
        #log-output {
            margin-top: 20px;
            background-color: #24292f;
            color: #c9d1d9;
            padding: 15px;
            border-radius: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .flex-container {
            display: flex;
            gap: 20px;
        }
        .flex-item {
            flex: 1;
        }
        @media (max-width: 768px) {
            .flex-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>GitHub å€‰åº«æª”æ¡ˆç®¡ç†å™¨</h1>
        
        <section>
            <h2>1. èªè­‰èˆ‡å€‰åº«è¨­å®š</h2>
            <div class="form-group">
                <label for="github-token">GitHub Personal Access Token (éœ€ repo æ¬Šé™)</label>
                <input type="password" id="github-token" placeholder="è²¼ä¸Šæ‚¨çš„ Token">
            </div>
            <div class="flex-container">
                <div class="form-group flex-item">
                    <label for="owner">å€‰åº«æ“æœ‰è€… (Owner)</label>
                    <input type="text" id="owner" placeholder="ä¾‹å¦‚: octocat">
                </div>
                <div class="form-group flex-item">
                    <label for="repo">å€‰åº«åç¨± (Repo)</label>
                    <input type="text" id="repo" placeholder="ä¾‹å¦‚: Hello-World">
                </div>
                <div class="form-group flex-item">
                    <label for="branch">åˆ†æ”¯ (Branch)</label>
                    <input type="text" id="branch" value="main">
                </div>
            </div>
        </section>

        <section>
            <h2>2. æª”æ¡ˆç€è¦½å™¨</h2>
            <div class="form-group">
                <label for="current-path">ç›®å‰è·¯å¾‘</label>
                <input type="text" id="current-path" value="">
            </div>
            <div class="button-group">
                <button onclick="listContents()">ç€è¦½/åˆ·æ–°ç›®å‰è·¯å¾‘</button>
            </div>
            <div id="file-browser" style="margin-top: 15px;">
                <ul id="file-list"></ul>
            </div>
        </section>

        <section>
            <h2>3. æª”æ¡ˆ/è³‡æ–™å¤¾æ“ä½œ</h2>
            <div class="form-group">
                <label for="file-path">æª”æ¡ˆè·¯å¾‘ (åŒ…å«æª”å)</label>
                <input type="text" id="file-path" placeholder="ä¾‹å¦‚: src/data/my-file.txt">
            </div>
            <div class="form-group">
                <label for="file-content">æª”æ¡ˆå…§å®¹ (å»ºç«‹æˆ–æ›´æ–°æ™‚éœ€è¦)</label>
                <textarea id="file-content"></textarea>
            </div>
            <div class="form-group">
                <label for="commit-message">æäº¤è¨Šæ¯ (Commit Message)</label>
                <input type="text" id="commit-message" value="Operate file via web manager">
            </div>
            <div class="button-group">
                <button onclick="createOrUpdateFile()">å»ºç«‹ / æ›´æ–°æª”æ¡ˆ</button>
                <button class="danger" onclick="deleteFile()">åˆªé™¤æª”æ¡ˆ</button>
                <button onclick="createFolder()">å»ºç«‹è³‡æ–™å¤¾ (åœ¨æ­¤è·¯å¾‘ä¸‹)</button>
            </div>
            <p style="font-size: 12px; color: #57606a;">æç¤ºï¼šå»ºç«‹è³‡æ–™å¤¾æœƒåœ¨å…¶è·¯å¾‘ä¸‹å‰µå»ºä¸€å€‹åç‚º <code>.gitkeep</code> çš„ç©ºæª”æ¡ˆã€‚</p>
        </section>

        <section>
            <h2>æ—¥èªŒè¼¸å‡º</h2>
            <div id="log-output">æ—¥èªŒè¨Šæ¯å°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡...</div>
        </section>
    </div>

    <script>
        // ç”¨æ–¼å„²å­˜ç›®å‰æ­£åœ¨ç·¨è¼¯æª”æ¡ˆçš„ SHA å€¼
        let currentFileSha = null;

        const GITHUB_API_BASE = "https://api.github.com";

        // --- Helper Functions ---

        function getAuthHeaders() {
            const token = document.getElementById('github-token').value;
            if (!token) {
                logMessage("éŒ¯èª¤: è«‹å…ˆè¼¸å…¥ GitHub Tokenã€‚", "error");
                throw new Error("Token is missing");
            }
            return {
                'Accept': 'application/vnd.github+json',
                'Authorization': `Bearer ${token}`,
                'X-GitHub-Api-Version': '2022-11-28'
            };
        }

        function getRepoInfo() {
            const owner = document.getElementById('owner').value;
            const repo = document.getElementById('repo').value;
            if (!owner || !repo) {
                logMessage("éŒ¯èª¤: è«‹è¼¸å…¥å€‰åº«æ“æœ‰è€…å’Œå€‰åº«åç¨±ã€‚", "error");
                throw new Error("Owner or repo is missing");
            }
            return { owner, repo };
        }
        
        function getBranch() {
            return document.getElementById('branch').value || 'main';
        }

        function logMessage(message, type = "info") {
            const logOutput = document.getElementById('log-output');
            const now = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff7b72' : (type === 'success' ? '#7ee787' : '#c9d1d9');
            logOutput.innerHTML = `<span style="color:${color};">[${now}] ${message}</span>\n` + logOutput.innerHTML;
        }

        // --- Core API Functions ---

        async function listContents(path = null) {
            const currentPathInput = document.getElementById('current-path');
            if (path === null) {
                path = currentPathInput.value;
            } else {
                currentPathInput.value = path;
            }
            
            logMessage(`æ­£åœ¨è®€å–è·¯å¾‘: '${path || "æ ¹ç›®éŒ„"}'...`);

            try {
                const { owner, repo } = getRepoInfo();
                const headers = getAuthHeaders();
                const branch = getBranch();
                
                const url = `${GITHUB_API_BASE}/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
                const response = await fetch(url, { headers });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP ${response.status}: ${errorData.message}`);
                }

                const data = await response.json();
                const fileList = document.getElementById('file-list');
                fileList.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨

                // è™•ç† "å›åˆ°ä¸Šä¸€å±¤"
                if (path) {
                    const parentPath = path.substring(0, path.lastIndexOf('/'));
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="file-icon">â†©ï¸</span> <a onclick="listContents('${parentPath}')">.. (å›åˆ°ä¸Šä¸€å±¤)</a>`;
                    fileList.appendChild(li);
                }

                // æ’åºï¼Œè³‡æ–™å¤¾åœ¨å‰ï¼Œæª”æ¡ˆåœ¨å¾Œ
                data.sort((a, b) => {
                    if (a.type === b.type) return a.name.localeCompare(b.name);
                    return a.type === 'dir' ? -1 : 1;
                });

                data.forEach(item => {
                    const li = document.createElement('li');
                    const icon = item.type === 'dir' ? 'ğŸ“' : 'ğŸ“„';
                    let action;
                    if (item.type === 'dir') {
                        action = `listContents('${item.path}')`;
                    } else {
                        action = `getFileContent('${item.path}')`;
                    }
                    li.innerHTML = `<span class="file-icon">${icon}</span> <a onclick="${action}">${item.name}</a>`;
                    fileList.appendChild(li);
                });
                logMessage(`æˆåŠŸè®€å–è·¯å¾‘ '${path || "æ ¹ç›®éŒ„"}' çš„å…§å®¹ã€‚`, "success");

            } catch (error) {
                logMessage(`è®€å–å…§å®¹å¤±æ•—: ${error.message}`, "error");
            }
        }

        async function getFileContent(path) {
            logMessage(`æ­£åœ¨è®€å–æª”æ¡ˆ '${path}'...`);
            try {
                const { owner, repo } = getRepoInfo();
                const headers = getAuthHeaders();
                const branch = getBranch();
                
                const url = `${GITHUB_API_BASE}/repos/${owner}/${repo}/contents/${path}?ref=${branch}`;
                const response = await fetch(url, { headers });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP ${response.status}: ${errorData.message}`);
                }

                const data = await response.json();
                
                if (data.encoding !== 'base64') {
                    throw new Error(`ä¸æ”¯æ´çš„æª”æ¡ˆç·¨ç¢¼: ${data.encoding} (æª”æ¡ˆå¯èƒ½éå¤§)`);
                }

                document.getElementById('file-path').value = data.path;
                document.getElementById('file-content').value = atob(data.content); // Base64 è§£ç¢¼
                currentFileSha = data.sha; // å„²å­˜ SHA ä»¥ä¾›æ›´æ–°/åˆªé™¤ä½¿ç”¨

                logMessage(`æˆåŠŸè¼‰å…¥æª”æ¡ˆ '${path}'ã€‚ç¾åœ¨æ‚¨å¯ä»¥ç·¨è¼¯ä¸¦æ›´æ–°å®ƒã€‚`, "success");
            } catch (error) {
                logMessage(`è®€å–æª”æ¡ˆå¤±æ•—: ${error.message}`, "error");
            }
        }

        async function createOrUpdateFile() {
            const path = document.getElementById('file-path').value;
            const content = document.getElementById('file-content').value;
            const message = document.getElementById('commit-message').value;

            if (!path || !message) {
                logMessage("éŒ¯èª¤: æª”æ¡ˆè·¯å¾‘å’Œæäº¤è¨Šæ¯ç‚ºå¿…å¡«é …ã€‚", "error");
                return;
            }
            
            const action = currentFileSha && document.getElementById('file-path').value === path ? 'æ›´æ–°' : 'å»ºç«‹';
            logMessage(`æ­£åœ¨${action}æª”æ¡ˆ '${path}'...`);

            try {
                const { owner, repo } = getRepoInfo();
                const headers = getAuthHeaders();
                const branch = getBranch();

                const url = `${GITHUB_API_BASE}/repos/${owner}/${repo}/contents/${path}`;
                
                const body = {
                    message,
                    content: btoa(content), // Base64 ç·¨ç¢¼
                    branch
                };

                // å¦‚æœæ˜¯æ›´æ–°ï¼Œå¿…é ˆæä¾› SHA
                if (action === 'æ›´æ–°') {
                    body.sha = currentFileSha;
                }

                const response = await fetch(url, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(body)
                });

                const responseData = await response.json();
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${responseData.message}`);
                }

                logMessage(`æˆåŠŸ${action}æª”æ¡ˆ '${path}'ï¼`, "success");
                currentFileSha = responseData.content.sha; // æ›´æ–° SHA
                
                // åˆ·æ–°çˆ¶ç›®éŒ„
                const parentPath = path.includes('/') ? path.substring(0, path.lastIndexOf('/')) : '';
                listContents(parentPath);

            } catch (error) {
                logMessage(`${action}æª”æ¡ˆå¤±æ•—: ${error.message}`, "error");
            }
        }

        async function deleteFile() {
            const path = document.getElementById('file-path').value;
            const message = document.getElementById('commit-message').value;

            if (!path) {
                logMessage("éŒ¯èª¤: è«‹å…ˆè¼‰å…¥æˆ–æŒ‡å®šè¦åˆªé™¤çš„æª”æ¡ˆè·¯å¾‘ã€‚", "error");
                return;
            }
            if (!currentFileSha) {
                logMessage("éŒ¯èª¤: ç¼ºå°‘æª”æ¡ˆçš„ SHA å€¼ã€‚è«‹å…ˆé»æ“Šç€è¦½å™¨ä¸­çš„æª”æ¡ˆä»¥è¼‰å…¥å…¶è³‡è¨Šã€‚", "error");
                return;
            }
            if (!confirm(`æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æª”æ¡ˆ '${path}' å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                logMessage("åˆªé™¤æ“ä½œå·²å–æ¶ˆã€‚");
                return;
            }

            logMessage(`æ­£åœ¨åˆªé™¤æª”æ¡ˆ '${path}'...`);

            try {
                const { owner, repo } = getRepoInfo();
                const headers = getAuthHeaders();
                const branch = getBranch();

                const url = `${GITHUB_API_BASE}/repos/${owner}/${repo}/contents/${path}`;
                
                const body = {
                    message,
                    sha: currentFileSha,
                    branch
                };

                const response = await fetch(url, {
                    method: 'DELETE',
                    headers,
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const responseData = await response.json();
                    throw new Error(`HTTP ${response.status}: ${responseData.message}`);
                }

                logMessage(`æˆåŠŸåˆªé™¤æª”æ¡ˆ '${path}'ï¼`, "success");
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('file-path').value = '';
                document.getElementById('file-content').value = '';
                currentFileSha = null;

                // åˆ·æ–°çˆ¶ç›®éŒ„
                const parentPath = path.includes('/') ? path.substring(0, path.lastIndexOf('/')) : '';
                listContents(parentPath);

            } catch (error) {
                logMessage(`åˆªé™¤æª”æ¡ˆå¤±æ•—: ${error.message}`, "error");
            }
        }
        
        async function createFolder() {
            const path = document.getElementById('file-path').value;
            if (!path) {
                logMessage("éŒ¯èª¤: è«‹åœ¨ 'æª”æ¡ˆè·¯å¾‘' æ¬„ä½ä¸­è¼¸å…¥æ‚¨æƒ³å»ºç«‹çš„è³‡æ–™å¤¾è·¯å¾‘ã€‚", "error");
                return;
            }

            // GitHub API ä¸èƒ½ç›´æ¥å»ºç«‹ç©ºè³‡æ–™å¤¾ï¼Œæ¨™æº–åšæ³•æ˜¯å»ºç«‹ä¸€å€‹ .gitkeep æª”æ¡ˆ
            const filePathWithGitkeep = path.endsWith('/') ? `${path}.gitkeep` : `${path}/.gitkeep`;
            const commitMessage = `Create folder ${path}`;
            
            logMessage(`æ­£åœ¨é€éå»ºç«‹ '${filePathWithGitkeep}' ä¾†å»ºç«‹è³‡æ–™å¤¾...`);

            try {
                const { owner, repo } = getRepoInfo();
                const headers = getAuthHeaders();
                const branch = getBranch();

                const url = `${GITHUB_API_BASE}/repos/${owner}/${repo}/contents/${filePathWithGitkeep}`;
                
                const body = {
                    message: commitMessage,
                    content: btoa(''), // ç©ºå…§å®¹
                    branch
                };

                const response = await fetch(url, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify(body)
                });

                const responseData = await response.json();
                if (!response.ok) {
                    // å¦‚æœæª”æ¡ˆå·²å­˜åœ¨ï¼Œä¹Ÿè¦–ç‚ºä¸€ç¨®æˆåŠŸ
                    if (response.status === 422 && responseData.message.includes("sha")) {
                         logMessage(`è³‡æ–™å¤¾ '${path}' æˆ–å…¶ .gitkeep æª”æ¡ˆå·²å­˜åœ¨ã€‚`, "info");
                         return;
                    }
                    throw new Error(`HTTP ${response.status}: ${responseData.message}`);
                }

                logMessage(`æˆåŠŸå»ºç«‹è³‡æ–™å¤¾ '${path}'ï¼`, "success");
                
                // åˆ·æ–°çˆ¶ç›®éŒ„
                const parentPath = path.includes('/') ? path.substring(0, path.lastIndexOf('/')) : '';
                listContents(parentPath);

            } catch (error) {
                logMessage(`å»ºç«‹è³‡æ–™å¤¾å¤±æ•—: ${error.message}`, "error");
            }
        }

    </script>

</body>
</html>