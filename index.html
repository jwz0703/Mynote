<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mynote - 檔案總管</title>
    <!-- 樣式與原始碼大致相同，僅移除編輯器相關樣式 -->
    <style>
        :root {
            --primary-bg: #f6f8fa;
            --secondary-bg: #ffffff;
            --border-color: #d0d7de;
            --text-color: #24292f;
            --link-color: #0969da;
            --button-bg: #2c974b;
            --button-hover-bg: #298e46;
            --button-text: #ffffff;
            --danger-bg: #d73a49;
            --danger-hover-bg: #cb2431;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
        }
        body {
            font-family: var(--font-family);
            background-color: var(--primary-bg);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            font-size: 16px;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 20px;
            box-sizing: border-box;
        }
        h1 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
        }
        button {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--button-text);
            background-color: var(--button-bg);
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        button:hover { background-color: var(--button-hover-bg); }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .settings-bar { display: flex; gap: 15px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; }
        .settings-bar input { padding: 8px; border: 1px solid var(--border-color); border-radius: 6px; flex-grow: 1; }
        #manager-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        #file-list { list-style: none; padding: 0; margin-top: 20px; }
        #file-list li {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
            gap: 10px;
        }
        #file-list li:hover { background-color: #f6f8fa; }
        #file-list li.deleting {
            opacity: 0.5;
            background-color: #ffebee;
            position: relative;
            overflow: hidden;
        }
        #file-list li.deleting::after {
            content: '刪除中...';
            position: absolute;
            right: 10px;
            color: var(--danger-bg);
            font-size: 12px;
        }
        .item-name { flex-grow: 1; cursor: pointer; color: var(--text-color); text-decoration: none; }
        .item-name:hover { color: var(--link-color); text-decoration: underline; }
        .item-actions { display: flex; gap: 8px; }
        .action-btn {
            background: none; border: none; padding: 4px; cursor: pointer; border-radius: 4px;
            color: var(--text-color);
        }
        .action-btn:hover { background-color: #e1e4e8; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .action-btn svg { display: block; }
        .danger-btn { color: var(--danger-bg); }
        .danger-btn:hover { background-color: var(--danger-bg); color: white; }
        a { color: inherit; text-decoration: none; }
        .refresh-btn {
            background-color: #0969da;
            color: white;
        }
        .refresh-btn:hover {
            background-color: #0860ca;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinning {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- --- 設定與 Token --- -->
        <div class="settings-bar">
            <input type="password" id="github-token" placeholder="貼上您的 GitHub Personal Access Token">
            <button onclick="saveToken()">儲存 Token</button>
        </div>

        <!-- --- 檔案總管畫面 --- -->
        <div id="manager-view">
            <div id="manager-header">
                <h1 id="manager-title"></h1>
                <div class="button-group">
                    <button onclick="createNewFile()">+ 新增檔案</button>
                    <button onclick="createNewFolder()">+ 新增資料夾</button>
                    <button onclick="triggerFileUpload()">+ 上傳檔案</button>
                    <button class="refresh-btn" onclick="forceRefresh()">
                        <svg id="refresh-icon" viewBox="0 0 16 16" width="16" height="16" fill="currentColor"><path d="M8 2.5a5.487 5.487 0 0 0-4.131 1.869l1.204 1.204A.25.25 0 0 1 4.896 6H1.25A.25.25 0 0 1 1 5.75V2.104a.25.25 0 0 1 .427-.177l1.38 1.38A7.002 7.002 0 0 1 14.95 7.16a.75.75 0 0 1-1.49.178A5.5 5.5 0 0 0 8 2.5ZM1.705 8.005a.75.75 0 0 1 .834.656 5.5 5.5 0 0 0 9.592 2.97l-1.204-1.204a.25.25 0 0 1 .177-.427h3.646a.25.25 0 0 1 .25.25v3.646a.25.25 0 0 1-.427.177l-1.38-1.38A7.002 7.002 0 0 1 1.05 8.84a.75.75 0 0 1 .656-.834Z"></path></svg>
                        重新整理
                    </button>
                </div>
            </div>
            <ul id="file-list"></ul>
        </div>
    </div>
    
    <!-- 隱藏的檔案上傳輸入框 -->
    <input type="file" id="file-uploader" style="display: none;" onchange="handleFileUpload(event)">

    <script>
        // --- 設定 ---
        const GITHUB_OWNER = "jwz0703";
        const GITHUB_REPO = "Mynote";
        const ROOT_PATH = "notes";
        const GITHUB_API_BASE = "https://api.github.com";

        // --- 狀態變數 ---
        let currentPath = ROOT_PATH;
        let currentFileList = [];
        let deletingItems = new Set();

        // --- SVG 圖示 (新增 download) ---
        const ICONS = {
            file: `<svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16H3.75A1.75 1.75 0 0 1 2 14.25Z"></path></svg>`,
            folder: `<svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor"><path d="M.5 1.75a.75.75 0 0 1 .75-.75h4.25a.75.75 0 0 1 .6.3L7.6 3.75h5.65a.75.75 0 0 1 .75.75v8.75a.75.75 0 0 1-.75-.75H1.25a.75.75 0 0 1-.75-.75V1.75Z"></path></svg>`,
            edit: `<svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor"><path d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 0 1-.927-.928l.929-3.25c.08-.286.234-.547.445-.758l8.61-8.61Zm.176 4.823L9.75 4.81l-6.286 6.287a.253.253 0 0 0-.064.108l-.558 1.953 1.953-.558a.253.253 0 0 0 .108-.064Zm1.238-3.763a.25.25 0 0 0-.354 0L10.81 3.75l1.439 1.44 1.263-1.263a.25.25 0 0 0 0-.354Z"></path></svg>`,
            delete: `<svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor"><path d="M11 1.75V3h2.25a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1 0-1.5H5V1.75C5 .784 5.784 0 6.75 0h2.5C10.216 0 11 .784 11 1.75Z M4.496 6.675l.66 6.6a.25.25 0 0 0 .249.225h5.19a.25.25 0 0 0 .249-.225l.66-6.6a.75.75 0 0 1 1.492.149l-.66 6.6A1.75 1.75 0 0 1 10.596 15H5.404a1.75 1.75 0 0 1-1.741-1.575l-.66-6.6a.75.75 0 1 1 1.492-.15Z M6.75 7.5a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-1.5 0v-4.5a.75.75 0 0 1 .75-.75Zm2.5 0a.75.75 0 0 1 .75.75v4.5a.75.75 0 0 1-1.5 0v-4.5a.75.75 0 0 1 .75-.75Z"></path></svg>`,
            download: `<svg viewBox="0 0 16 16" width="16" height="16" fill="currentColor"><path d="M.5 9.75a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 0 .75.75h12a.75.75 0 0 0 .75-.75v-1.5a.75.75 0 0 1 1.5 0v1.5A2.25 2.25 0 0 1 13.75 15h-12A2.25 2.25 0 0 1 .5 12.75v-1.5a.75.75 0 0 1 .75-.75Z M8 1a.75.75 0 0 1 .75.75v6.59l2.97-2.97a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L4.22 6.43a.75.75 0 1 1 1.06-1.06l2.97 2.97V1.75A.75.75 0 0 1 8 1Z"></path></svg>`
        };

        // --- 核心功能 ---
        window.onload = () => {
            logMessage("歡迎使用 Mynote 檔案總管！");
            loadToken();
            const urlParams = new URLSearchParams(window.location.search);
            const pathFromUrl = urlParams.get('path');
            listFiles(pathFromUrl || ROOT_PATH);
        };

        function logMessage(message, type = "info") {
            const now = new Date().toLocaleTimeString();
            const formattedMessage = `[${now}] ${message}`;
            if (type === 'error') console.error(formattedMessage);
            else if (type === 'success') console.log(`%c${formattedMessage}`, 'color: #28a745; font-weight: bold;');
            else console.info(formattedMessage);
        }

        // --- Token 處理 ---
        function saveToken() {
            const token = document.getElementById('github-token').value;
            if (token) {
                localStorage.setItem('githubToken', token);
                logMessage("Token 已儲存。", "success");
                listFiles();
            } else {
                logMessage("Token 為空，無法儲存。", "error");
            }
        }

        function loadToken() {
            const token = localStorage.getItem('githubToken');
            if (token) {
                document.getElementById('github-token').value = token;
                logMessage("已自動載入儲存的 Token。");
            } else {
                logMessage("請輸入您的 GitHub Token 並儲存。", "info");
            }
        }

        function getAuthHeaders() {
            const token = document.getElementById('github-token').value;
            if (!token) {
                logMessage("錯誤: 缺少 GitHub Token。", "error");
                throw new Error("Token is missing");
            }
            return {
                'Accept': 'application/vnd.github+json',
                'Authorization': `Bearer ${token}`,
                'X-GitHub-Api-Version': '2022-11-28'
            };
        }
        
        // --- API 請求核心函式 ---
        async function githubApiRequest(url, options = {}) {
            const headers = getAuthHeaders();
            const response = await fetch(url, { ...options, headers: { ...headers, ...options.headers } });
            const data = response.status === 204 ? null : await response.json();
            if (!response.ok) {
                throw new Error(`GitHub API Error: ${response.status} ${data?.message || response.statusText}`);
            }
            return data;
        }

        // --- 強制重新整理功能 ---
        async function forceRefresh() {
            const refreshIcon = document.getElementById('refresh-icon');
            refreshIcon.classList.add('spinning');
            
            currentFileList = [];
            deletingItems.clear();
            
            await listFiles(currentPath);
            
            setTimeout(() => {
                refreshIcon.classList.remove('spinning');
            }, 1000);
        }

        // --- 檔案總管功能 ---
        async function listFiles(path = currentPath) {
            currentPath = path;
            const url = new URL(window.location);
            url.searchParams.set('path', currentPath);
            history.pushState({}, '', url);
            
            logMessage(`正在從 ${GITHUB_OWNER}/${GITHUB_REPO}/${currentPath} 讀取...`);
            document.getElementById('manager-title').textContent = `總管: /${currentPath}`;
            const fileListEl = document.getElementById('file-list');
            fileListEl.innerHTML = '<li>載入中...</li>';

            try {
                const url = `${GITHUB_API_BASE}/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${currentPath}`;
                const data = await githubApiRequest(url);
                
                currentFileList = data;
                renderFileList();
                
                logMessage("檔案列表載入成功。", "success");

            } catch (error) {
                 if (error.message.includes("404")) {
                    logMessage(`目錄 /${currentPath}/ 不存在。您可以透過'新增'來建立它。`, "info");
                    fileListEl.innerHTML = `<li>目錄 /${currentPath}/ 不存在。</li>`;
                } else {
                    logMessage(`讀取檔案列表失敗: ${error.message}`, "error");
                    fileListEl.innerHTML = `<li>讀取失敗，請檢查 Token 和網路。</li>`;
                }
            }
        }

        // --- 渲染檔案列表 (已修改加入下載按鈕) ---
        function renderFileList() {
            const fileListEl = document.getElementById('file-list');
            fileListEl.innerHTML = '';

            if (currentPath !== ROOT_PATH) {
                const parentPath = currentPath.substring(0, currentPath.lastIndexOf('/')) || ROOT_PATH;
                const li = document.createElement('li');
                li.innerHTML = `
                    ${ICONS.folder}
                    <a href="#" class="item-name" onclick="event.preventDefault(); listFiles('${parentPath}')">..</a>
                `;
                fileListEl.appendChild(li);
            }

            const items = currentFileList.sort((a, b) => {
                if (a.type === b.type) return a.name.localeCompare(b.name);
                return a.type === 'dir' ? -1 : 1;
            });

            if (items.length === 0 && currentPath === ROOT_PATH) {
                 fileListEl.innerHTML = `<li>此目錄 /${ROOT_PATH}/ 為空或不存在。</li>`;
            }

            items.forEach(item => {
                const li = document.createElement('li');
                li.id = `item-${item.path.replace(/[\/\.]/g, '-')}`;
                
                const isDir = item.type === 'dir';
                const icon = isDir ? ICONS.folder : ICONS.file;
                const isDeleting = deletingItems.has(item.path);
                
                if (isDeleting) li.classList.add('deleting');
                
                let nameHtml = '';
                let actionsHtml = '';

                if (isDir) {
                    nameHtml = `<a href="#" class="item-name" onclick="event.preventDefault(); listFiles('${item.path}')">${item.name}</a>`;
                    actionsHtml = `
                        <button class="action-btn danger-btn" title="刪除" 
                                onclick="deleteItem('${item.path}', '${item.name}', '${item.sha}', '${item.type}')"
                                ${isDeleting ? 'disabled' : ''}>${ICONS.delete}</button>
                    `;
                } else {
                    const isMd = item.name.endsWith('.md');
                    const link = isMd ? `editor.html?path=${item.path}` : item.download_url;
                    const target = isMd ? '' : 'target="_blank" rel="noopener noreferrer"';
                    
                    nameHtml = `<a href="${link}" ${target} class="item-name">${item.name}</a>`;
                    
                    let editAction = isMd ? `<a href="editor.html?path=${item.path}" class="action-btn" title="編輯">${ICONS.edit}</a>` : '';
                    
                    actionsHtml = `
                        <a href="${item.download_url}" download="${item.name}" class="action-btn" title="下載">${ICONS.download}</a>
                        ${editAction}
                        <button class="action-btn danger-btn" title="刪除" 
                                onclick="deleteItem('${item.path}', '${item.name}', '${item.sha}', '${item.type}')"
                                ${isDeleting ? 'disabled' : ''}>${ICONS.delete}</button>
                    `;
                }

                li.innerHTML = `
                    ${icon}
                    ${nameHtml}
                    <div class="item-actions">
                        ${actionsHtml}
                    </div>
                `;
                fileListEl.appendChild(li);
            });
        }

        function createNewFile() {
            const filename = prompt("請輸入新檔案的名稱 (例如: my-note.md):");
            if (filename && filename.trim() !== '' && filename.endsWith('.md')) {
                const path = `${currentPath}/${filename.trim()}`;
                window.location.href = `editor.html?path=${encodeURIComponent(path)}`;
            } else if (filename) {
                alert("檔名不得為空，且必須以 .md 結尾。");
            }
        }
        
        async function createNewFolder() {
            const folderName = prompt("請輸入新資料夾的名稱:");
            if (!folderName || folderName.trim() === '') return;

            const path = `${currentPath}/${folderName.trim()}/.gitkeep`;
            logMessage(`正在建立資料夾: ${folderName}...`);

            try {
                const url = `${GITHUB_API_BASE}/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`;
                await githubApiRequest(url, {
                    method: 'PUT',
                    body: JSON.stringify({
                        message: `feat: create folder '${folderName}'`,
                        content: btoa(''),
                        branch: 'main'
                    })
                });
                logMessage(`資料夾 '${folderName}' 建立成功。`, "success");
                await forceRefresh();
            } catch (error) {
                logMessage(`建立資料夾失敗: ${error.message}`, "error");
            }
        }
        
        // --- 上傳功能 (新增) ---
        function triggerFileUpload() {
            document.getElementById('file-uploader').click();
        }

        async function handleFileUpload(event) {
            const fileInput = event.target;
            const file = fileInput.files[0];
            if (!file) return;

            logMessage(`準備上傳檔案: ${file.name}`);

            const existingFile = currentFileList.find(item => item.name === file.name && item.type === 'file');
            let sha = null;

            if (existingFile) {
                if (!confirm(`檔案 "${file.name}" 已存在。您要覆蓋它嗎？`)) {
                    logMessage("上傳已取消。", "info");
                    fileInput.value = ''; // 重設 input 以便下次能觸發 change 事件
                    return;
                }
                sha = existingFile.sha;
                logMessage(`準備覆蓋檔案，SHA: ${sha}`, "info");
            }

            try {
                const content = await readFileAsBase64(file);
                const path = `${currentPath}/${file.name}`;
                await uploadFile(path, file.name, content, sha);
            } catch (error) {
                logMessage(`讀取檔案時發生錯誤: ${error.message}`, "error");
            } finally {
                fileInput.value = ''; // 完成後重設 input
            }
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64Content = reader.result.split(',')[1];
                    resolve(base64Content);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function uploadFile(path, name, content, sha = null) {
            const message = sha ? `feat: update file '${name}'` : `feat: create file '${name}'`;
            logMessage(`正在上傳 "${name}"...`);

            try {
                const url = `${GITHUB_API_BASE}/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`;
                const body = {
                    message: message,
                    content: content,
                    branch: 'main'
                };
                if (sha) body.sha = sha;

                await githubApiRequest(url, {
                    method: 'PUT',
                    body: JSON.stringify(body)
                });

                logMessage(`檔案 "${name}" 上傳成功。`, "success");
                await forceRefresh();
            } catch (error) {
                logMessage(`上傳檔案失敗: ${error.message}`, "error");
                alert(`上傳檔案失敗: ${error.message}`);
            }
        }


        // --- 刪除功能 ---
        async function deleteItem(path, name, sha, type) {
            logMessage(`開始刪除 ${type === 'dir' ? '資料夾' : '檔案'} "${name}"...`, 'info');
            
            deletingItems.add(path);
            renderFileList(); // 重新渲染以顯示刪除中狀態

            try {
                if (type === 'dir') {
                    await _performRecursiveDelete(path);
                } else {
                    await deleteSingleFile(path, sha);
                }
                
                logMessage(`${type === 'dir' ? '資料夾' : '檔案'} "${name}" 已成功刪除。`, 'success');
                await forceRefresh();
                
            } catch (error) {
                logMessage(`刪除 "${name}" 失敗: ${error.message}`, "error");
                deletingItems.delete(path);
                renderFileList(); // 失敗時也重新渲染以移除刪除中狀態
            }
        }

        async function _performRecursiveDelete(path) {
            const contents = await githubApiRequest(`${GITHUB_API_BASE}/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`);
            const deletePromises = contents.map(item => {
                return item.type === 'dir' ? _performRecursiveDelete(item.path) : deleteSingleFile(item.path, item.sha);
            });
            await Promise.all(deletePromises);
        }

        async function deleteSingleFile(path, sha) {
            const url = `${GITHUB_API_BASE}/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`;
            await githubApiRequest(url, {
                method: 'DELETE',
                body: JSON.stringify({
                    message: `chore: delete file ${path}`,
                    sha: sha,
                    branch: 'main'
                })
            });
        }
    </script>
</body>
</html>